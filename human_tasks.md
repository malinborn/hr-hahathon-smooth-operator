# Human Tasks: Mattermost ↔ n8n Proxy

## 1) Mattermost
- Создать бота или PAT для бота.
- Получить и передать значения:
  - `MATTERMOST_WS_URL` (wss://<host>/api/v4/websocket)
  - `MATTERMOST_API_URL` (https://<host>/api/v4)
  - `MATTERMOST_BOT_TOKEN` (Bot Token или PAT)
  - `BOT_USER_ID` (опционально; чтобы фильтровать собственные сообщения)
- Убедиться, что боту разрешены ЛС и он добавлен в нужные каналы (для тестов — любой канал с тредом).
- Подготовить тестовый тред: получить `channel_id` и `root_id` для проверки `POST /answer` и `POST /get_thread`.

## 2) n8n
- Создать workflow с входящим Webhook для приёма событий из сервиса.
- Сгенерировать и зафиксировать `N8N_WEBHOOK_SECRET`.
- Настроить проверку заголовка `X-Webhook-Secret` в workflow (отклонять, если секрет не совпадает).
- Дать рабочий `N8N_INBOUND_WEBHOOK_URL` (прод/стейдж), доступный из интернета/ВМ.
- На первых порах — выводить входящий payload в Debug для быстрой диагностики.

## 3) Инфраструктура и доступы
- Подготовить Ubuntu‑VM с доступом по SSH.
- Установить Docker и Docker Compose plugin.
- Создать каталог деплоя на ВМ (например, `/opt/mmproxy`) и открыть порт `8080` (или настроить обратный прокси).
- Создать файл `/opt/mmproxy/.env` со значениями переменных окружения:
  > **Примечание:** Файл `docker-compose.yaml` будет создан автоматически при первом деплое через CI/CD.
  - `MATTERMOST_WS_URL`
  - `MATTERMOST_API_URL`
  - `MATTERMOST_BOT_TOKEN`
  - `BOT_USER_ID` (опц.)
  - `N8N_INBOUND_WEBHOOK_URL`
  - `N8N_WEBHOOK_SECRET`
  - `SERVICE_API_KEY`
  - `SERVICE_PORT=8080`
- Добавить секреты в GitHub Actions (репозиторий проекта):
  - `VM_HOST` — IP-адрес или hostname ВМ
  - `VM_USERNAME` — username для SSH доступа
  - `VM_SSH_KEY` — приватный SSH ключ для доступа к ВМ
  - `VM_SSH_PORT` (опционально) — SSH порт, по умолчанию 22

## 4) Секреты и передача
- Сгенерировать `SERVICE_API_KEY` и безопасно передать (или сразу разместить в `.env` на ВМ).
- Все секреты не коммитить в репозиторий. Передавать через секрет‑хранилище (1Password/Vault) или Actions Secrets.

## 5) Доступности и сети
- Убедиться, что ВМ имеет исходящий доступ к:
  - Mattermost API/WebSocket по указанным хостам.
  - n8n webhook URL.
- Если используется wss/https с кастомными сертификатами — подтвердить доверие/маршрутизацию.

## 6) Проверка (ручной smoke‑тест)
- Написать ЛС боту → событие приходит в n8n, секрет валиден.
- Написать сообщение в тред → событие `thread_post` приходит в n8n.
- Вызвать `POST /answer` (тред) → сообщение публикуется в треде.
- Вызвать `POST /get_thread` → возвращаются корневой пост и реплаи в корректном порядке, `limit` работает.
- Отправить запрос к API с неверным `X-API-Key` → получить 401.

## 7) Что передать мне
После выполнения всех шагов выше, подтвердите:
- ✅ ВМ подготовлена: Docker установлен, директория `/opt/mmproxy` создана
- ✅ Файл `.env` создан на ВМ со всеми переменными
- ✅ GitHub Secrets настроены: `VM_HOST`, `VM_USERNAME`, `VM_SSH_KEY`, `VM_SSH_PORT` (опционально)
- ✅ SSH доступ работает (можно протестировать вручную)
- ✅ Mattermost бот создан и имеет нужные права
- ✅ n8n webhook настроен и доступен

Для тестирования также понадобятся:
- Тестовые идентификаторы: `channel_id`, `root_id` (для треда)
- `user_id`/`username` для тестирования DM (опционально)
